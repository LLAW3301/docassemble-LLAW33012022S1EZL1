---
code: |
  # set step to 'submit'
  nav.set_section('submit')
  # allow user to review answers
  if EL_userFinalAction == 'submit':
    # if user submits the form, send email to user and Ezra
    EL_sendEmails
    # hide navigation items on the side
    nav.hide()
    # hide the save and resume button - no need to save any longer
    EL_showSaveResumeButton = False 
    # show confirmation message
    EL_confirmSubmit  
  else:
    # hide navigation items on the side
    nav.hide()
    # hide the save and resume button - no need to save as session was deleted
    EL_showSaveResumeButton = False 
    # confirm to user that their answers have been deleted
    EL_confirmCancel
    
  # tell DA to run this file/code block when encountering the below variable
  EL_ReviewSection = True
---
code: |
  # the file containing all answers is assembled using a docx template and the
  # attachement block below (EL_compiledAnswers).
  # emails are constructed in their separate template blocks below 
  # (EL_Template_EzraEmail and EL_Template_UserEmail)
  
  # the attachements sent must include the compiled answers but should only include
  # uploaded files if they exist
  EL_emailAttachments = [EL_compiledAnswers]
  if EL_hasSupportingDocs:
    EL_emailAttachments.append(EL_supportingDocs)
  # send emails to user and Ezra, containing compiled answers and any attachments
  EL_userEmailSentOk = send_email(to=EL_User, template=EL_Template_ClientEmail, attachments=[EL_compiledAnswers])
  # TODO: EL_EzraEmailSentOk = send_email(to=EL_ClientEmailAddress, template=EL_Template_EzraEmail, attachments=[EL_compiledAnswers])
  
  EL_sendEmails = True
---
template: EL_Template_EzraEmail
subject: |
  New client request has been received!
content: |
  ${ EL_User.name } needs your legal assistance
  % if EL_AskWhatLegalProblem == 'Other/Unsure':
    but ${ EL_User.pronoun_possessive('issue') } might not be covered by your practice areas.
  % else:
    with ${ indefinite_article(EL_AskWhatLegalProblem) } matter.
  % endif
  
  For further details, please find attached ${ EL_User.pronoun_possessive('answers') }
  % if EL_hasSupportingDocs: 
  and the supporting documents ${ EL_User.pronoun_subjective() } uploaded 
  % endif
  .
  
  Regards
---
template: EL_Template_ClientEmail
subject: |
  Thank you for contacting Ezra Legal
content: |
  Dear ${ EL_User.salutation(with_name=True) },  

  We wanted to let you know that we have received your enquiry and will be in touch shortly.  
  
  In the meantime, please find attached a copy of what we have received. 
  
  Should you have any question or concern, please do not hesitate to contact us on (08) 8231 6100 or via email at admin@ezralegal.com.au.

  Kind regards,  
  Ezra Legal Team
---
attachment:
  - name: Compiled Answers
    filename: Answers
    variable name: EL_compiledAnswers
    description: |
      Contains all answers provided in this interview session.
    docx template file: compiled_answers.docx
    valid formats:
    - pdf
---
prevent going back: True
question: Review & Submit
subquestion: |
  Please check that your answers below are correct before submitting.
  
  <br>
  <div class="card">
    <h5 class="card-header" style="border-bottom: none;display: flex;align-items: center;justify-content: flex-start;">
      <span style="flex: 1;"> Personal Information </span>
      <a href="${ url_ask(['EL_User.name.first', 'EL_User.occupation']) }" class="btn btn-info">Edit</a>
    </h5>
    <div class="card-body">
      <div class="container-fluid">
        % for EL_Q in EL_PersonalInfoSectionQs:
        % if loop.index > 0:
        <hr>
        % endif
        <div class="row" style="align-items: center;">
          <div class="col-auto">
            ${ EL_Q['question'] } 
          </div>
          <div class="col" style="font-weight: bold;">
            ${ showifdef(EL_Q['variable_name']) }
          </div>
        </div>
        % endfor
      </div>
    </div>
  </div>
  
  <br>
  <div class="card">
    <h5 class="card-header" style="border-bottom: none;display: flex;align-items: center;justify-content: flex-start;">
      <span style="flex: 1;"> Contact Details </span>
      <a href="${ url_ask('EL_User.email') }" class="btn btn-info">Edit</a>
    </h5>
    <div class="card-body">
      <div class="container-fluid">
        % for EL_Q in EL_contactDetailsSectionQs:
        % if loop.index > 0:
        <hr>
        % endif
        <div class="row" style="align-items: center;">
          <div class="col-auto">
            ${ EL_Q['question'] } 
          </div>
          <div class="col" style="font-weight: bold;">
            % if defined(EL_Q['variable_name']):
            ${ value(EL_Q['variable_name']) }
            % endif
          </div>
        </div>
        % endfor
      </div>
    </div>
  </div>
  
  <br>
  <div class="card">
    <h5 class="card-header" style="border-bottom: none;">
      Legal Matter
    </h5>
    <div class="card-body">
      <div class="container-fluid">
        % for EL_Q in EL_legalProblemSectionQs:
        % if loop.index > 0:
        <hr>
        % endif
        <div class="row" style="align-items: center;">
          <div class="col-auto">
            ${ EL_Q['question'] } 
          </div>
          <div class="col" style="font-weight: bold;">
            ${ EL_Q['value'] if "value" in EL_Q else value(EL_Q['variable_name']) }
          </div>
          <div class="col-2">
            <a href="${ url_ask(EL_Q['edit_variable']) if "edit_variable" in EL_Q else url_ask(EL_Q['variable_name'])  }" class="btn btn-info">Edit</a>
          </div>
        </div>
        % endfor
      </div>
    </div>
  </div>
  <br>
field: EL_userFinalAction
buttons:
  - Submit: submit
  - Cancel: cancel
---
prevent going back: True
event: EL_confirmSubmit
question: Thank you for your request
subquestion: |
  We have received your enquiry and will get in touch as soon as possible. A confirmation has been sent to the email address you have provided.
buttons:
  - Return to homepage: exit
post: |
  <br>
  <hr>
  <br>
  * **For demonstration purposes only**, previews of the email and assembled document are shown below. (NOTE: if you entered a genuine email at the Contact Details page you should also recieve an email â€” as user not Ezra)
  
  **Compiled Answers**
  
  ${ EL_compiledAnswers }
  
  <br> 
  **Email to Ezra**
  
  ${ EL_Template_EzraEmail.show() }
  
  
  <br> 
  **Email to user/applicant**
  
  ${ EL_Template_ClientEmail.show() }
  
---
prevent going back: True
event: EL_confirmCancel
question: Answers deleted
subquestion: |
  We have deleted your answers 
  % if EL_hasSupportingDocs: 
  and all files you have uploaded 
  % endif
  .
buttons:
  - Restart: restart
  - Exit: exit
---